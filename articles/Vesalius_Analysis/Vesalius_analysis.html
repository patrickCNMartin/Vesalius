<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vesalius Manuscript Analysis • vesalius</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Vesalius Manuscript Analysis">
<meta property="og:description" content="vesalius">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">vesalius</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../articles/vesalius.html">Get started</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/Vesalius_Analysis/Vesalius_analysis.html">Vesalius Manuscript Analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/patrickCNMartin/Vesalius/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Vesalius_analysis_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Vesalius Manuscript Analysis</h1>
                        <h4 class="author">Patrick C.N. Martin</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/patrickCNMartin/Vesalius/blob/main/vignettes/Vesalius_Analysis/Vesalius_analysis.Rmd"><code>vignettes/Vesalius_Analysis/Vesalius_analysis.Rmd</code></a></small>
      <div class="hidden name"><code>Vesalius_analysis.Rmd</code></div>

    </div>

    
    
<div id="preface" class="section level1">
<h1 class="hasAnchor">
<a href="#preface" class="anchor"></a>Preface</h1>
<p>The purpose of this file is to demonstrate the the workflow used to produce the Vesalius paper. This file contains all code related to the manuscript as well as comments of the code itself.</p>
<p>It should be noted that we save and use intermediate files in this work flow. Please ensure that you modify the path towards files accordingly.</p>
</div>
<div id="set-up" class="section level1">
<h1 class="hasAnchor">
<a href="#set-up" class="anchor"></a>Set up</h1>
<p>First, we will set up the R environment to run Vesalius. Note that some of the packages are Vesalius dependencies but for sake of clarity, they are also listed here. We also set a seed. Some functions (such as <code>kmeans</code>) requires random start points. This seed ensure that you will (hopefully) recover the same territories as we had in the paper.</p>
<div id="libraries" class="section level2">
<h2 class="hasAnchor">
<a href="#libraries" class="anchor"></a>Libraries</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patrickcnmartin.github.io/Vesalius/">vesalius</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ShotaOchi/imagerExtra">imagerExtra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat">Seurat</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/">viridis</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/kisungyou/tvR">tvR</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/edzer/sp/">sp</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grid</span><span class="op">)</span>


<span class="co"># Standard libraries - just in case you are a command line fiend</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">utils</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">stats</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">graphics</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">grDevices</span><span class="op">)</span>
<span class="co">### Set seed</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="running-vesalius-analysis" class="section level1">
<h1 class="hasAnchor">
<a href="#running-vesalius-analysis" class="anchor"></a>Running Vesalius Analysis</h1>
<div id="rgb-embeddings" class="section level2">
<h2 class="hasAnchor">
<a href="#rgb-embeddings" class="anchor"></a>RGB embeddings</h2>
<p>The first step of the Vesalius algorithm is to load and pre-process spatial transcriptomic data. For this manuscript, we used slide-seqV2 data provided on the <a href="https://singlecell.broadinstitute.org/single_cell/study/SCP948/robust-decomposition-of-cell-type-mixtures-in-spatial-transcriptomics#study-download">Single Cell Portal</a>. Our analysis mainly focused on the mouse brain and embryo (E12.5).</p>
<p>Once the data has been loaded and pre-processed (log normalisation, scaling, Finding variable features - handled by Seurat), the data can be parsed to Vesalius for embedding into the RGB colour space.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#-----------------------/Slide-seq Data Loading/-------------------------------#</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Only 2 pucks were used - but ultimately you can add as many as you want</span>
<span class="co"># The first one is the mouse Hippocampus, the second is mouse embryo</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">slideTag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Puck_200115_08"</span>,<span class="st">"Puck_190926_03"</span><span class="op">)</span>

<span class="va">slideBeads</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_200115_08_bead_locations.csv"</span>,
               <span class="st">"~/group/slide_seqV2/Puck_190926_03_bead_locations.csv"</span><span class="op">)</span>

<span class="va">slideCounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_200115_08.digital_expression.txt.gz"</span>,
                 <span class="st">"~/group/slide_seqV2/Puck_190926_03.digital_expression.txt.gz"</span><span class="op">)</span>


<span class="co">#-----------------------/Slide-seq analysis/-----------------------------------#</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Next we can set a few parameters for the pre-processing</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co">## number of variable features</span>
<span class="va">nfeatures</span> <span class="op">&lt;-</span> <span class="fl">2000</span>

<span class="co">## FindVariableFeatures method</span>
<span class="va">method</span> <span class="op">&lt;-</span> <span class="st">"vst"</span>

<span class="co">## Number of PCA slices - each slice will cover 3 PCs</span>
<span class="va">slices</span> <span class="op">&lt;-</span> <span class="fl">3</span>

<span class="co">## Plot output directory</span>
<span class="va">plots</span> <span class="op">&lt;-</span> <span class="st">"~/group/slide_seqV2/plots/"</span>

<span class="co">## Invert colour code - F = black dominant &amp; T = White dominant</span>
<span class="co">## Colour inversion is not strickly speaking necessary. Light colours are</span>
<span class="co">## however easier to visualise.  </span>
<span class="va">invert</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>

<span class="co">## Image processing Matrices output directory</span>
<span class="va">IP</span> <span class="op">&lt;-</span> <span class="st">"~/group/slide_seqV2/IP/"</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Looping over files and converting PCA loading values to RGB colours</span>
<span class="co">#------------------------------------------------------------------------------#</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">slideTag</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Loading Bead file"</span>,<span class="va">slideTag</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="co"># Loading coordinates</span>
  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="va">bead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ReadSlideSeq.html">ReadSlideSeq</a></span><span class="op">(</span><span class="va">slideBeads</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>


  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Loading Count file"</span>,<span class="va">slideTag</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="co"># Unconventional loading - however required as some data sets</span>
  <span class="co"># Fail to load  - This ensures all data sets can be loaded</span>
  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="va">ctmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="va">slideCounts</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, header <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">ctmp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">ctmp</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
  <span class="va">ctmp</span> <span class="op">&lt;-</span> <span class="va">ctmp</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>


  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="co"># Creating seurat spatial object</span>
  <span class="co"># NOTE this code is taken from the Seurat source code as it does not seem that</span>
  <span class="co"># Slide seq loading function are all exported</span>
  <span class="co"># If this has been updated - this section can be changed accordingly</span>
  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="va">ctmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/CreateSeuratObject.html">CreateSeuratObject</a></span><span class="op">(</span><span class="va">ctmp</span>, assay <span class="op">=</span><span class="st">"Spatial"</span><span class="op">)</span>
  <span class="va">bead</span> <span class="op">&lt;-</span> <span class="va">bead</span><span class="op">[</span><span class="fu"><a href="https://satijalab.org/seurat/reference/Cells.html">Cells</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ctmp</span><span class="op">)</span><span class="op">]</span>
  <span class="fu"><a href="https://satijalab.org/seurat/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">bead</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Spatial"</span>
  <span class="va">ctmp</span><span class="op">[[</span><span class="st">"slice1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bead</span>
  <span class="co">#ctmp &lt;- subset(ctmp, subset = nFeature_Spatial &gt; 100 &amp; nFeature_Spatial &lt; 4500 &amp; percent.mt &lt; 5)</span>
  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="co"># Seuart pre-processing steps</span>
  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="va">ctmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html">NormalizeData</a></span><span class="op">(</span><span class="va">ctmp</span><span class="op">)</span>
  <span class="va">ctmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html">FindVariableFeatures</a></span><span class="op">(</span><span class="va">ctmp</span>, selection.method <span class="op">=</span> <span class="va">method</span>, nfeatures <span class="op">=</span> <span class="va">nfeatures</span><span class="op">)</span>
  <span class="va">ctmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html">ScaleData</a></span><span class="op">(</span><span class="va">ctmp</span><span class="op">)</span>

  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="co"># Embed PCA loading into the RGB colour space.</span>
  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="va">ctmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/rgbPCA.html">rgbPCA</a></span><span class="op">(</span><span class="va">ctmp</span>, slices <span class="op">=</span> <span class="va">slices</span> , conserveSparse <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="co"># For each slice, assign colour code to it's coordinates</span>
  <span class="co"># NOTE we do not have an image yet. We have a colour code associated with</span>
  <span class="co"># an x and y coordinates. We refer to these coordinates as pixels</span>
  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="co">#----------------------------------------------------------------------------#</span>
  <span class="co"># We export the coordinates for later use. This file is the basis of image</span>
  <span class="co"># creation.</span>
  <span class="co">#----------------------------------------------------------------------------#</span>

  <span class="va">filenames</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">IP</span>,<span class="st">"PCA_to_RGB_log_"</span>,<span class="va">nfeatures</span>,
                                 <span class="st">"_slice"</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span><span class="va">slices</span><span class="op">)</span>,<span class="st">"_"</span>,<span class="va">slideTag</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,<span class="st">".csv"</span><span class="op">)</span>
  <span class="fu"><a href="../../reference/exportRGB.csv.html">exportRGB.csv</a></span><span class="op">(</span><span class="va">ctmp</span>,file <span class="op">=</span> <span class="va">filenames</span>, split <span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>


<span class="op">}</span></code></pre></div>
</div>
<div id="image-array-creation" class="section level2">
<h2 class="hasAnchor">
<a href="#image-array-creation" class="anchor"></a>Image Array Creation</h2>
<p>The next step uses the data frames generated above to build image arrays. Here, we will use intermediate files instead of using loaded variables. By doing so, we can run this section independently if the previous section has already been run.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#-------------------/Territory Isolation - Hippocampus/------------------------#</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Loading saved data frame after PCA to RGB conversion</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/IP/PCA_to_RGB_log_2000_slice1_Puck_200115_08.csv"</span>,
                              header<span class="op">=</span><span class="cn">T</span>, stringsAsFactors<span class="op">=</span><span class="cn">F</span><span class="op">)</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Next we build the image</span>
<span class="co"># We recommend using more than one core.</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/buildImageArray.html">buildImageArray</a></span><span class="op">(</span><span class="va">imageBrain</span>,invert<span class="op">=</span><span class="cn">T</span>,
                              filterThreshold <span class="op">=</span> <span class="fl">0.9975</span>,
                              resolution <span class="op">=</span> <span class="fl">40</span>, cores <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Next we equalise the histogram. We use the default BalanceSimplest method</span>
<span class="co"># Other methods are available and are detailed in the package vignette</span>
<span class="co"># sleft and sright describe the extent of histogram balancing on the left and on</span>
<span class="co"># the right of the histogram.</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/equalizeHistogram.html">equalizeHistogram</a></span><span class="op">(</span><span class="va">imageBrain</span>,sleft <span class="op">=</span> <span class="fl">2.5</span>, sright<span class="op">=</span><span class="fl">2.5</span>,invert <span class="op">=</span><span class="cn">T</span><span class="op">)</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Image regularisation - this considers overall variance to smooth the image</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/regulariseImage.html">regulariseImage</a></span><span class="op">(</span><span class="va">imageBrain</span>, lambda <span class="op">=</span> <span class="fl">10</span>,
                              niter <span class="op">=</span> <span class="fl">200</span>, normalise<span class="op">=</span><span class="cn">T</span>,invert<span class="op">=</span><span class="cn">T</span><span class="op">)</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># This image actually quite pretty so you can have a look using one of the</span>
<span class="co"># Vesalius plotting functions.</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co">#pdf("imageBrain_regEQ.pdf")</span>
<span class="co">#imagePlot(imageBrain,as.cimg=F,cex =12)</span>
<span class="co">#dev.off()</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Now we can start to segment!</span>
<span class="co"># It should be noted that the smoothing is done internally</span>
<span class="co"># You can smooth using our smoothArray function but we essentially run that</span>
<span class="co"># function within the iterative segmentation function</span>
<span class="co"># colDepth = number of colour segments</span>
<span class="co"># smoothIter = number of smoothing rounds PRIOR to segmentation</span>
<span class="co"># methods = smoothing methods (they will be applied in the order they are given)</span>
<span class="co"># sigma = sigma for gaussian blur</span>
<span class="co"># box = size of median kernel</span>
<span class="co"># useCenter = we use only the centre pixel</span>
<span class="co"># invert = if colour should be inverted (if true then background is "white")</span>
<span class="co">#------------------------------------------------------------------------------#</span>

<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/iterativeSegmentation.array.html">iterativeSegmentation.array</a></span><span class="op">(</span><span class="va">imageBrain</span>, colDepth <span class="op">=</span> <span class="fl">6</span>,
                                          smoothIter <span class="op">=</span> <span class="fl">20</span>,
                                          method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"iso"</span>,<span class="st">"median"</span><span class="op">)</span>,
                                          sigma<span class="op">=</span><span class="fl">1.5</span>,box <span class="op">=</span> <span class="fl">10</span>,
                                          useCenter <span class="op">=</span> <span class="cn">T</span>,
                                          invert <span class="op">=</span><span class="cn">T</span><span class="op">)</span>


<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Using the colour segments to extract territories</span>
<span class="co"># captureRadius = proportion of maximum distance between two beads. We use an</span>
<span class="co"># absolute distance metric so that the captureRadius is the same between all</span>
<span class="co"># territories. NOTE: this is not the same as KNN as here we don't care about</span>
<span class="co"># number of neighbours but rather the distance to neighbours.</span>
<span class="co"># minBar = minimum number of cells that should be in a territory. If below this</span>
<span class="co"># value, then we we will pool all of those territories into one territory</span>
<span class="co"># called "isolated"</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/isolateTerritories.array.html">isolateTerritories.array</a></span><span class="op">(</span><span class="va">imageBrain</span>,
                                        captureRadius <span class="op">=</span> <span class="fl">0.008</span>,
                                        minBar <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Finally some plotting</span>
<span class="co"># IMPORTANT: the "split" show all territories separately - it just makes</span>
<span class="co"># visualisation and territory selection easier. Please refer to this plot</span>
<span class="co"># to select territories if in doubt.</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">imgSmoothed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/imagePlot.html">imagePlot</a></span><span class="op">(</span><span class="va">imageBrain</span>, as.cimg <span class="op">=</span> <span class="cn">F</span>,cex <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">imgTerritory</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/territoryPlot.html">territoryPlot</a></span><span class="op">(</span><span class="va">imageBrain</span>, randomise <span class="op">=</span> <span class="cn">TRUE</span>,cex <span class="op">=</span><span class="fl">15</span> , cex.pt<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>,
         legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>,
         plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span><span class="fl">15</span><span class="op">)</span>,
         legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html">pdf</a></span><span class="op">(</span><span class="st">"vesalius_Territory.pdf"</span>, width <span class="op">=</span> <span class="fl">8</span>, height <span class="op">=</span><span class="fl">6</span><span class="op">)</span>
<span class="va">imgTerritory</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>As seen in the code above, we select a filter threshold. This filter threshold ensures that we remove tessellation artefacts. The tessellation algorithm extends the coordinate system to create a box around all barcode coordinates.</p>
<p>It creates tiles that are tied to the external box and we want to filter these tiles as well as the tile that are too large. The <code>filterThreshold</code> describes the quantile at which tile areas should be discarded. The same <code>filterThreshold</code> to is applied to points that are to far away from other points (i.e. stray beads).</p>
<p>Note the <code>resolution</code> argument is set to 100. This argument determines if the image must be resize. The larger the image the higher the resolution but the slower the analysis. For this section, we only want to demonstrate the direct output of building RGB images from transcriptional profiles.</p>
</div>
<div id="running-vesalius-in-lower-resolution" class="section level2">
<h2 class="hasAnchor">
<a href="#running-vesalius-in-lower-resolution" class="anchor"></a>Running Vesalius in lower resolution</h2>
<p>Here, we demonstrate running Vesalius over 12 10X Visium data sets taken from <a href="https://www.nature.com/articles/s41593-020-00787-0">here</a>. All files were downloaded and distributed into seperate directories. We assess run time for each data set and compared performance using an ARI score. Please note that the comprative analysis code can be found <a href="https://github.com/patrickCNMartin/Vesalius/blob/main/methodComp/methodComp.R">here</a>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">input</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.dirs</a></span><span class="op">(</span><span class="st">"~/group/visium/DLPFC_globus"</span>,recursive <span class="op">=</span><span class="cn">F</span><span class="op">)</span>
<span class="va">time</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">input</span><span class="op">)</span><span class="op">)</span>
<span class="va">count</span> <span class="op">&lt;-</span> <span class="fl">1</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">input</span><span class="op">)</span><span class="op">{</span>

  <span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">i</span>,<span class="st">"/Vesalius"</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.exists</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      <span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="va">sec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/Read10X.html">Read10X</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>
  <span class="va">img</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/Read10X_Image.html">Read10X_Image</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>
  <span class="va">sec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/CreateSeuratObject.html">CreateSeuratObject</a></span><span class="op">(</span>counts <span class="op">=</span> <span class="va">sec</span>, assay <span class="op">=</span> <span class="st">"Spatial"</span><span class="op">)</span>
  <span class="va">img</span> <span class="op">&lt;-</span> <span class="va">img</span><span class="op">[</span><span class="fu"><a href="https://satijalab.org/seurat/reference/Cells.html">Cells</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">sec</span><span class="op">)</span><span class="op">]</span>
  <span class="fu"><a href="https://satijalab.org/seurat/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">img</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Spatial"</span>
  <span class="va">sec</span><span class="op">[[</span><span class="st">"slice1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">img</span>

  <span class="va">sec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/NormalizeData.html">NormalizeData</a></span><span class="op">(</span><span class="va">sec</span><span class="op">)</span>
  <span class="va">sec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindVariableFeatures.html">FindVariableFeatures</a></span><span class="op">(</span><span class="va">sec</span>, selection.method <span class="op">=</span> <span class="st">"vst"</span>, nfeatures <span class="op">=</span> <span class="fl">2000</span><span class="op">)</span>
  <span class="va">sec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ScaleData.html">ScaleData</a></span><span class="op">(</span><span class="va">sec</span><span class="op">)</span>



  <span class="va">sec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/rgbUMAP.html">rgbUMAP</a></span><span class="op">(</span><span class="va">sec</span>, pcs <span class="op">=</span> <span class="fl">30</span>, conserveSparse <span class="op">=</span><span class="cn">F</span><span class="op">)</span>

  <span class="va">image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/buildImageArray.html">buildImageArray</a></span><span class="op">(</span><span class="va">sec</span>, resolution <span class="op">=</span> <span class="fl">100</span>, filterThreshold <span class="op">=</span> <span class="fl">1</span>, invert <span class="op">=</span><span class="cn">F</span><span class="op">)</span>
  <span class="va">image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/equalizeHistogram.html">equalizeHistogram</a></span><span class="op">(</span><span class="va">image</span>, sleft <span class="op">=</span> <span class="fl">15</span>,sright <span class="op">=</span><span class="fl">15</span>,invert <span class="op">=</span><span class="cn">F</span><span class="op">)</span>

  <span class="va">image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/iterativeSegmentation.array.html">iterativeSegmentation.array</a></span><span class="op">(</span><span class="va">image</span>,
      colDepth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">11</span>,<span class="fl">7</span>, by <span class="op">=</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span>,
      smoothIter <span class="op">=</span> <span class="fl">1</span>,
      method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"median"</span>,<span class="st">"iso"</span><span class="op">)</span>,
      sigma<span class="op">=</span><span class="fl">1</span>,
      box <span class="op">=</span> <span class="fl">13</span>,
      useCenter <span class="op">=</span> <span class="cn">T</span>,
      invert <span class="op">=</span><span class="cn">F</span><span class="op">)</span>
  <span class="va">image</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/isolateTerritories.array.html">isolateTerritories.array</a></span><span class="op">(</span><span class="va">image</span>, captureRadius <span class="op">=</span> <span class="fl">0.035</span>,minBar <span class="op">=</span><span class="fl">5</span><span class="op">)</span>

  <span class="va">tag</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span><span class="va">i</span>, <span class="st">"/"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
  <span class="va">tag</span> <span class="op">&lt;-</span> <span class="va">tag</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">tag</span><span class="op">)</span><span class="op">]</span>

  <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">i</span>,<span class="st">"/Vesalius/"</span>,<span class="va">tag</span>,<span class="st">"_vesalius.rda"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">image</span>,file <span class="op">=</span> <span class="va">file</span><span class="op">)</span>
  <span class="va">e</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">time</span><span class="op">[[</span><span class="va">count</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">e</span> <span class="op">-</span> <span class="va">s</span>
  <span class="va">count</span> <span class="op">&lt;-</span> <span class="va">count</span> <span class="op">+</span><span class="fl">1</span>

<span class="op">}</span>
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">time</span>, file <span class="op">=</span> <span class="st">"Vesalius_time.Rda"</span><span class="op">)</span></code></pre></div>
</div>
<div id="image-building-for-territory-isolation" class="section level2">
<h2 class="hasAnchor">
<a href="#image-building-for-territory-isolation" class="anchor"></a>Image building for territory isolation</h2>
<p>In this section, we will focus on the creation and manipulation of Vesalius images in order to produce territories used for in depth analysis. We will make the assumption that you have already run the PCA to RGB conversion and saved the intermediate file.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#-------------------/Territory Isolation - Hippocampus/------------------------#</span>
<span class="va">bead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ReadSlideSeq.html">ReadSlideSeq</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_200115_08_bead_locations.csv"</span><span class="op">)</span>


<span class="va">brainRaw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_200115_08.digital_expression.txt.gz"</span>, header <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">brainRaw</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">brainRaw</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
<span class="va">brainRaw</span> <span class="op">&lt;-</span> <span class="va">brainRaw</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>

<span class="va">brainRaw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/CreateSeuratObject.html">CreateSeuratObject</a></span><span class="op">(</span><span class="va">brainRaw</span>, assay <span class="op">=</span><span class="st">"Spatial"</span><span class="op">)</span>
<span class="va">bead</span> <span class="op">&lt;-</span> <span class="va">bead</span><span class="op">[</span><span class="fu"><a href="https://satijalab.org/seurat/reference/Cells.html">Cells</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ctmp</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://satijalab.org/seurat/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">bead</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Spatial"</span>
<span class="va">brainRaw</span><span class="op">[[</span><span class="st">"slice1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bead</span>

<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/IP/PCA_to_RGB_log_2000_slice1_Puck_200115_08.csv"</span>,
                              header<span class="op">=</span><span class="cn">T</span>, stringsAsFactors<span class="op">=</span><span class="cn">F</span><span class="op">)</span>

<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/buildImageArray.html">buildImageArray</a></span><span class="op">(</span><span class="va">imageBrain</span>,invert<span class="op">=</span><span class="cn">T</span>,
                              filterThreshold <span class="op">=</span> <span class="fl">0.999</span>,
                              resolution <span class="op">=</span> <span class="fl">40</span>, cores <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>

<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/equalizeHistogram.html">equalizeHistogram</a></span><span class="op">(</span><span class="va">imageBrain</span>,sleft <span class="op">=</span> <span class="fl">2.5</span>, sright<span class="op">=</span><span class="fl">2.5</span>,invert <span class="op">=</span><span class="cn">T</span><span class="op">)</span>


<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/regulariseImage.html">regulariseImage</a></span><span class="op">(</span><span class="va">imageBrain</span>, lambda <span class="op">=</span> <span class="fl">10</span>,
                              niter <span class="op">=</span> <span class="fl">200</span>, normalise<span class="op">=</span><span class="cn">T</span><span class="op">)</span>


<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/iterativeSegmentation.array.html">iterativeSegmentation.array</a></span><span class="op">(</span><span class="va">imageBrain</span>, colDepth <span class="op">=</span> <span class="fl">6</span>,
                                          smoothIter <span class="op">=</span> <span class="fl">20</span>,
                                          method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"iso"</span>,<span class="st">"median"</span><span class="op">)</span>,
                                          sigma<span class="op">=</span><span class="fl">1.5</span>,box <span class="op">=</span> <span class="fl">10</span>,
                                          useCenter <span class="op">=</span> <span class="cn">T</span>,
                                          invert <span class="op">=</span><span class="cn">T</span><span class="op">)</span>

<span class="va">imageBrain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/isolateTerritories.array.html">isolateTerritories.array</a></span><span class="op">(</span><span class="va">imageBrain</span>,
                                        captureRadius <span class="op">=</span> <span class="fl">0.008</span>,
                                        minBar <span class="op">=</span> <span class="fl">40</span><span class="op">)</span></code></pre></div>
</div>
<div id="territory-isolation-from-vesalius-images" class="section level2">
<h2 class="hasAnchor">
<a href="#territory-isolation-from-vesalius-images" class="anchor"></a>Territory isolation from Vesalius images</h2>
<p>We can build an image array from the saved data frames. It should be noted that in this instance, we are using a different filtering threshold. We want to leave a bit more on the edges so the we don’t smooth background instead of barcode values. We also reduce the size of the image (40% of original size) to reduce computational time.</p>
<p>One important aspect to remember is that every function presented here returns a dataframe. This makes conversion a lot easier. You can use this data frame and load it in your favourite environment and play around with it. They follow the imager (Cimg) format: barcode, x, y, cc, value and meta data.</p>
<p>cc represents the colour channel. value is the value associated to the colour channel. Meta data may represent different things but generally it will be associated to colour clusters or territories.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#----------------------/Territory Isolation - Embryo/--------------------------#</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># First we load both slices and build image arrays with RGB embeddings</span>
<span class="co"># We are mainly interest in slice three as we use slice three to isolate the eye</span>
<span class="co"># That being said we will also run Vesalius on slice 1 to demonstrate territory</span>
<span class="co"># isolation in the embryo</span>
<span class="co"># We also load the count data for later use</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">bead</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/ReadSlideSeq.html">ReadSlideSeq</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_190926_03_bead_locations.csv"</span><span class="op">)</span>


<span class="va">embryoCounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.table</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/Puck_190926_03.digital_expression.txt.gz"</span>, header <span class="op">=</span> <span class="cn">TRUE</span> <span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">embryoCounts</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">embryoCounts</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>
<span class="va">embryoCounts</span> <span class="op">&lt;-</span> <span class="va">embryoCounts</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>

<span class="va">embryoCounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/CreateSeuratObject.html">CreateSeuratObject</a></span><span class="op">(</span><span class="va">embryoCounts</span>, assay <span class="op">=</span><span class="st">"Spatial"</span><span class="op">)</span>
<span class="va">bead</span> <span class="op">&lt;-</span> <span class="va">bead</span><span class="op">[</span><span class="fu"><a href="https://satijalab.org/seurat/reference/Cells.html">Cells</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ctmp</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://satijalab.org/seurat/reference/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">bead</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"Spatial"</span>
<span class="va">embryoCounts</span><span class="op">[[</span><span class="st">"slice1"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">bead</span>

<span class="va">imageEmbryo3</span> <span class="op">&lt;-</span> <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/IP/PCA_to_RGB_log_2000_slice3_Puck_190926_03.csv"</span>,
                                 header<span class="op">=</span><span class="cn">T</span>, stringsAsFactors<span class="op">=</span><span class="cn">F</span><span class="op">)</span>
<span class="va">imageEmbryo1</span> <span class="op">&lt;-</span> <span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"~/group/slide_seqV2/IP/PCA_to_RGB_log_2000_slice1_Puck_190926_03.csv"</span>,
                                 header<span class="op">=</span><span class="cn">T</span>, stringsAsFactors<span class="op">=</span><span class="cn">F</span><span class="op">)</span>

<span class="va">imageEmbryo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/buildImageArray.html">buildImageArray</a></span><span class="op">(</span><span class="va">imageEmbryo3</span>,
                               slice <span class="op">=</span> <span class="fl">3</span>,
                               invert<span class="op">=</span><span class="cn">T</span>,
                               filterThreshold <span class="op">=</span> <span class="fl">0.999</span>,
                               resolution <span class="op">=</span> <span class="fl">40</span>,
                               cores <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">imageEmbryo1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/buildImageArray.html">buildImageArray</a></span><span class="op">(</span><span class="va">imageEmbryo1</span>,
                               slice <span class="op">=</span> <span class="fl">1</span>,
                               invert<span class="op">=</span><span class="cn">T</span>,
                               filterThreshold <span class="op">=</span> <span class="fl">0.999</span>,
                               resolution <span class="op">=</span> <span class="fl">40</span>,
                               cores <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co">#----------------------------------------------------------------------------#</span>
<span class="co"># These steps are the same as the one described for the Hippocampus</span>
<span class="co">#----------------------------------------------------------------------------#</span>
<span class="va">imageEmbryo3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/equalizeHistogram.html">equalizeHistogram</a></span><span class="op">(</span><span class="va">imageEmbryo3</span>,
                                 sleft <span class="op">=</span> <span class="fl">2.5</span>, sright <span class="op">=</span> <span class="fl">2.5</span>,invert <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">imageEmbryo1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/equalizeHistogram.html">equalizeHistogram</a></span><span class="op">(</span><span class="va">imageEmbryo1</span>,
                                  sleft <span class="op">=</span> <span class="fl">2.5</span>, sright <span class="op">=</span> <span class="fl">2.5</span>,invert <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">imageEmbryo3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/regulariseImage.html">regulariseImage</a></span><span class="op">(</span><span class="va">imageEmbryo3</span>,lambda <span class="op">=</span><span class="fl">10</span>,invert <span class="op">=</span><span class="cn">T</span><span class="op">)</span>
<span class="va">imageEmbryo1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/regulariseImage.html">regulariseImage</a></span><span class="op">(</span><span class="va">imageEmbryo1</span>,lambda <span class="op">=</span><span class="fl">10</span>,invert<span class="op">=</span><span class="cn">T</span><span class="op">)</span>

<span class="co">#----------------------------------------------------------------------------#</span>
<span class="co"># Now we can segment images - here we use a slightly different smoothing</span>
<span class="co"># approach. On top of multiple rounds of smoothing and using different methods,</span>
<span class="co"># we also smooth across different levels (parse as vector to sigma and box).</span>
<span class="co"># Default is to take the min pixel value between each sigma or box value</span>
<span class="co">#----------------------------------------------------------------------------#</span>
<span class="va">imageEmbryo3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/iterativeSegmentation.array.html">iterativeSegmentation.array</a></span><span class="op">(</span><span class="va">imageEmbryo3</span>,
                                           colDepth <span class="op">=</span> <span class="fl">8</span>,
                                           smoothIter <span class="op">=</span> <span class="fl">20</span>,
                                           method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"iso"</span>,<span class="st">"box"</span><span class="op">)</span>,
                                           sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">2</span>,by<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>,
                                           box <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">9</span>,by<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,
                                           invert <span class="op">=</span><span class="cn">T</span>,
                                           useCenter<span class="op">=</span><span class="cn">F</span><span class="op">)</span>

<span class="va">imageEmbryo1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/iterativeSegmentation.array.html">iterativeSegmentation.array</a></span><span class="op">(</span><span class="va">imageEmbryo1</span>,
                                           colDepth <span class="op">=</span> <span class="fl">8</span>,
                                           smoothIter <span class="op">=</span> <span class="fl">20</span>,
                                           method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"iso"</span>,<span class="st">"box"</span><span class="op">)</span>,
                                           sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">2</span>,by<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>,
                                           box <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">9</span>,by<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,
                                           invert <span class="op">=</span><span class="cn">T</span>,
                                           useCenter<span class="op">=</span><span class="cn">F</span><span class="op">)</span>
<span class="co">#----------------------------------------------------------------------------#</span>
<span class="co"># This section is the same for the hippocampus - we use a slightly larger</span>
<span class="co"># captureRadius.</span>
<span class="co">#----------------------------------------------------------------------------#</span>
<span class="va">imageEmbryo3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/isolateTerritories.array.html">isolateTerritories.array</a></span><span class="op">(</span><span class="va">imageEmbryo3</span>,
                                        captureRadius <span class="op">=</span> <span class="fl">0.025</span>,minBar <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>

<span class="va">imageEmbryo1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/isolateTerritories.array.html">isolateTerritories.array</a></span><span class="op">(</span><span class="va">imageEmbryo1</span>,
                                        captureRadius <span class="op">=</span> <span class="fl">0.025</span>,minBar <span class="op">=</span> <span class="fl">40</span><span class="op">)</span>


<span class="co">#----------------------------------------------------------------------------#</span>
<span class="co"># Finally some plotting - Commented out for speed</span>
<span class="co"># This code section is the code section used to produce plots in the manuscript</span>
<span class="co">#----------------------------------------------------------------------------#</span>
<span class="co">#imgSmoothedEm &lt;- imagePlot(imageEmbryo3, as.cimg = F,cex = 15) + theme_void()</span>
<span class="co">#imgTerritoryEm &lt;- territoryPlot(imageEmbryo3, randomise = TRUE,cex =15 , cex.pt=0.25)+</span>
                  <span class="co">#theme_void()+</span>
                  <span class="co">#theme(legend.text = element_text(size = 12),</span>
                  <span class="co">#      legend.title = element_text(size=12),</span>
                  <span class="co">#      plot.title = element_text(size=15))+</span>
                  <span class="co">#labs(title = "Slide-seq V2 - Embryo (E12.5)")</span>

<span class="co">#pdf(paste0("smoother_and_territory_embryo_slice3.pdf"), width = 7, height=5.5)</span>
<span class="co">#g &lt;- imgTerritoryEm</span>
<span class="co">#print(g)</span>
<span class="co">#dev.off()</span>

<span class="co">#pdf(paste0("embryo_split_slice",i,".pdf"),width =20, height = 20)</span>
<span class="co">#print(territoryPlot(imageEmbryo,split = T,randomise = F,cex=10))</span>
<span class="co">#dev.off()</span>

<span class="co">#imgSmoothedEm1 &lt;- imagePlot(imageEmbryo1, as.cimg = F,cex = 15) + theme_void()</span>
<span class="co">#imgTerritoryEm1 &lt;- territoryPlot(imageEmbryo1, randomise = TRUE,cex =15 , cex.pt=0.25)+</span>
<span class="co">#                    theme_void()+</span>
<span class="co">#                    theme(legend.text = element_text(size = 12),</span>
<span class="co">#                          legend.title = element_text(size=12),</span>
<span class="co">#                          plot.title = element_text(size=15))+</span>
<span class="co">#                    labs(title = "Slide-seq V2 - Embryo (E12.5)")</span>
<span class="co">#pdf(paste0("smoother_and_territory_embryo_slice1.pdf"), width = 7, height=5.5)</span>
<span class="co">#imgTerritoryEm1</span>

<span class="co">#dev.off()</span></code></pre></div>
</div>
<div id="territory-clustering" class="section level2">
<h2 class="hasAnchor">
<a href="#territory-clustering" class="anchor"></a>Territory Clustering</h2>
<p>Isolated territories can be used for in depth analysis. In the manuscript, we focused on three example territories. In this section we will show how each territory was handled for further analysis.</p>
<p>It should be noted that all cell type or tissue type were done manually by using marker genes.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#----------------/Territory in depth Analysis - Hippocampus/-------------------#</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># We can isolate the territories associated with the CA field and the third</span>
<span class="co"># ventricle and medial habenula and the embryonic eye.</span>
<span class="co">#</span>
<span class="co"># NOTE: we applied a slight dilation to the third ventricle and medial habenula</span>
<span class="co"># This ensures that we fill in all gaps between territories</span>
<span class="co"># The morphology factor value is expressed in number of pixels</span>
<span class="co">#</span>
<span class="co"># NOTE: Here use brainRaw i.e. non processed count data as the "pre-procesing"</span>
<span class="co"># will be taken care of here.</span>
<span class="co"># seedID = territory number</span>
<span class="co">#</span>
<span class="co"># NOTE: Sorry another note... but seedID may vary depending on your starting</span>
<span class="co"># seed. Use the territoryPlot function with split = TRUE to visualize</span>
<span class="co"># all territories independently and select the desired territories.</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">CACluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extractTerritories.html">extractTerritories</a></span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainRaw</span>,
                                seedID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">19</span><span class="op">)</span>,morphologyFactor<span class="op">=</span><span class="fl">0</span><span class="op">)</span>

<span class="va">medCluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extractTerritories.html">extractTerritories</a></span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainRaw</span>,
                                 seedID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">46</span>,<span class="fl">47</span><span class="op">)</span>,morphologyFactor<span class="op">=</span><span class="fl">15</span><span class="op">)</span>


<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Clustering analysis carried out by Seurat</span>
<span class="co"># Here we use the recommended pipeline as we are clustering barcodes and not</span>
<span class="co"># producing images.</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">CACluster</span> <span class="op">&lt;-</span> <span class="va">CACluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
             <span class="fu"><a href="https://satijalab.org/seurat/reference/SCTransform.html">SCTransform</a></span><span class="op">(</span>assay <span class="op">=</span> <span class="st">"Spatial"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
             <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
             <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
             <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html">FindNeighbors</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
             <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html">FindClusters</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>


<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Finding and extracting markers for each cluster (top 15 based on log FC)</span>
<span class="co"># This compares clusters between each other and does not consider all other</span>
<span class="co"># barcodes. Used for annotation.</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">CAMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindAllMarkers.html">FindAllMarkers</a></span><span class="op">(</span><span class="va">CACluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html">top_n</a></span><span class="op">(</span><span class="fl">15</span>,wt <span class="op">=</span> <span class="va">avg_logFC</span><span class="op">)</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Extracting genes that are differentially expressed in the cluster</span>
<span class="co"># after comparing those barcodes to all other barcodes. This differs from</span>
<span class="co"># the section above as we are not only considering barcodes in the isolated</span>
<span class="co"># territory but all all other territories</span>
<span class="co"># As such, we use normalised count values (brainCounts was previously preprocessed)</span>
<span class="co"># Used for annotation.</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">CAClusterMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extractClusterMarkers.html">extractClusterMarkers</a></span><span class="op">(</span><span class="va">CACluster</span>,<span class="va">brainCounts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
                    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seedTerritory</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html">top_n</a></span><span class="op">(</span><span class="fl">20</span>,wt <span class="op">=</span> <span class="va">logFC</span><span class="op">)</span>


<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Custom plotting  with cell type annotation</span>
<span class="co"># Barcodes were annotated manually - see supplementary table 1 in manuscript</span>
<span class="co"># Colour comes from a colour blind friendly palette</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">CA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FetchData.html">FetchData</a></span><span class="op">(</span><span class="va">CACluster</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"UMAP_1"</span>,<span class="st">"UMAP_2"</span>,<span class="st">"seurat_clusters"</span><span class="op">)</span><span class="op">)</span>


<span class="va">CA_ISH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"CA1 Pyramidal Layer"</span>,
            <span class="st">"CA3 Pyramidal Layer"</span>,
            <span class="st">"CA1 Pyramidal Layer"</span>,
            <span class="st">"CA1 Pyramidal Layer"</span>,
            <span class="st">"CA2 Pyramidal Layer"</span>,
            <span class="st">"Neurons"</span>,
            <span class="st">"Microglia"</span><span class="op">)</span>
<span class="va">coordCA</span> <span class="op">&lt;-</span> <span class="fu">Vesalius</span><span class="fu">:::</span><span class="fu">getSeuratCoordinates</span><span class="op">(</span><span class="va">CACluster</span><span class="op">)</span>
<span class="va">CA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">CA</span>,<span class="va">coordCA</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>xs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">UMAP_1</span><span class="op">)</span>,ys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">UMAP_2</span><span class="op">)</span><span class="op">)</span>

<span class="va">lvls</span> <span class="op">&lt;-</span> <span class="va">CA_ISH</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">CA</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>
<span class="va">CA</span><span class="op">$</span><span class="va">seurat_clusters</span> <span class="op">&lt;-</span> <span class="va">lvls</span>

<span class="va">CA_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">CA</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>,
          <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">6</span>,<span class="fl">8</span>,<span class="fl">5</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span>
<span class="va">umap_CA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">CA</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">UMAP_1</span>,<span class="va">UMAP_2</span>,col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.2</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span><span class="va">cols</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span><span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span>,
                  axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                  axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                  plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span>,hjust<span class="op">=</span><span class="fl">0</span><span class="op">)</span>,
                  plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,
                  plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.2</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
            <span class="co">#guides(colour = guide_legend(override.aes = list(size=4)))+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"CA Field - Pyramidal layer"</span>,
                              x <span class="op">=</span> <span class="st">"UMAP 1"</span>, y <span class="op">=</span> <span class="st">"UMAP 2"</span><span class="op">)</span>

<span class="va">coord_CA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">CA</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.4</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                  <span class="co">#axis.text = element_text(size = 20),</span>
                  <span class="co">#axis.title = element_text(size = 20),</span>
                  legend.position <span class="op">=</span> <span class="st">"right"</span>,
                  plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                  plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,
                  plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">" "</span>, title <span class="op">=</span> <span class="st">" "</span>,
                x <span class="op">=</span> <span class="st">"X coordinates"</span>, y <span class="op">=</span> <span class="st">"Y coordinates"</span><span class="op">)</span>


<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># The same process is applied to the third ventricle and medial habenula</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">medCluster</span> <span class="op">&lt;-</span> <span class="va">medCluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
             <span class="fu"><a href="https://satijalab.org/seurat/reference/SCTransform.html">SCTransform</a></span><span class="op">(</span>assay <span class="op">=</span> <span class="st">"Spatial"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
             <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
             <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
             <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html">FindNeighbors</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">medCluster</span> <span class="op">&lt;-</span> <span class="va">medCluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span><span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html">FindClusters</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fl">0.85</span><span class="op">)</span>

<span class="va">medMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindAllMarkers.html">FindAllMarkers</a></span><span class="op">(</span><span class="va">medCluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html">top_n</a></span><span class="op">(</span><span class="fl">25</span>,wt <span class="op">=</span> <span class="va">avg_logFC</span><span class="op">)</span>
<span class="va">medClusterMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extractClusterMarkers.html">extractClusterMarkers</a></span><span class="op">(</span><span class="va">medCluster</span>,<span class="va">brainCounts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seedTerritory</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html">top_n</a></span><span class="op">(</span><span class="fl">25</span>,wt <span class="op">=</span> <span class="va">logFC</span><span class="op">)</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Here we compare cluster between each other and more specifically clusters</span>
<span class="co"># associated with the medial habenula and the third ventricle.</span>
<span class="co"># This is where we get compartment specific gene expression</span>
<span class="co"># medComp = medial habenula</span>
<span class="co"># tvCompt = third ventricle</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">medComp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindMarkers.html">FindMarkers</a></span><span class="op">(</span><span class="va">medCluster</span>,ident.1 <span class="op">=</span> <span class="fl">1</span>, ident.2 <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">tvCompt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindMarkers.html">FindMarkers</a></span><span class="op">(</span><span class="va">medCluster</span>,ident.1 <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">11</span>,<span class="fl">4</span><span class="op">)</span>,ident.2<span class="op">=</span><span class="fl">2</span><span class="op">)</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Plotting</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">med</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FetchData.html">FetchData</a></span><span class="op">(</span><span class="va">medCluster</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"UMAP_1"</span>,<span class="st">"UMAP_2"</span>,<span class="st">"seurat_clusters"</span><span class="op">)</span><span class="op">)</span>
<span class="va">med_ISH</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Third Ventricle"</span>,
            <span class="st">"Medial Habenula - Low"</span>,
             <span class="st">"Medial Habenula"</span>,
             <span class="st">"Third Ventricle - Low"</span>,
              <span class="st">"Unassigned"</span>,
              <span class="st">"Third Ventricle"</span>,
              <span class="st">"Ependymal Cells - TV"</span>,
              <span class="st">"Oligodendrocyte - MH"</span>,
              <span class="st">"Oligodendrocyte - TV"</span>,
              <span class="st">"Neuron"</span>,
              <span class="st">"Unassigned"</span>,
              <span class="st">"Third Ventricle"</span><span class="op">)</span>
<span class="va">coordmed</span> <span class="op">&lt;-</span> <span class="fu">Vesalius</span><span class="fu">:::</span><span class="fu">getSeuratCoordinates</span><span class="op">(</span><span class="va">medCluster</span><span class="op">)</span>
<span class="va">med</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">med</span>,<span class="va">coordmed</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>xs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">UMAP_1</span><span class="op">)</span>,ys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">UMAP_2</span><span class="op">)</span><span class="op">)</span>
<span class="va">lvls</span> <span class="op">&lt;-</span> <span class="va">med_ISH</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">med</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>
<span class="va">med</span><span class="op">$</span><span class="va">seurat_clusters</span> <span class="op">&lt;-</span> <span class="va">lvls</span>

<span class="va">med_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">med</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span>
<span class="va">med_pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>,
                                <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span><span class="op">)</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu">med_pal</span><span class="op">(</span><span class="va">med_col</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">med_col</span><span class="op">)</span><span class="op">]</span>

<span class="va">umap_med</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">med</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">UMAP_1</span>,<span class="va">UMAP_2</span>,col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span><span class="va">cols</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span><span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span><span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span>,
                  axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                  axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                  plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span>,hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,
                  plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,
                  plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="fl">1.2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
            <span class="co">#guides(colour = guide_legend(override.aes = list(size=4)))+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"Third Ventricle - Medial Habenula"</span>,
                              x <span class="op">=</span> <span class="st">"UMAP 1"</span>, y <span class="op">=</span> <span class="st">"UMAP 2"</span><span class="op">)</span>

<span class="va">coord_med</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">med</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.5</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                  legend.position <span class="op">=</span> <span class="st">"right"</span>,
                  <span class="co">#axis.text = element_text(size = 20),</span>
                  <span class="co">#axis.title = element_text(size = 20),,</span>
                  plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                  plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,
                  plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">0</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">" "</span>, title <span class="op">=</span> <span class="st">""</span>,
                x <span class="op">=</span> <span class="st">"X coordinates"</span>, y <span class="op">=</span> <span class="st">"Y coordinates"</span><span class="op">)</span>



<span class="co">#------------------/Territory in depth Analysis - Embryo/----------------------#</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># We applied the same process to embryo isolated clusters</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">eyeCluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extractTerritories.html">extractTerritories</a></span><span class="op">(</span><span class="va">imageEmbryo</span>,<span class="va">embryoCounts</span>,seedID <span class="op">=</span> <span class="fl">11</span><span class="op">)</span>



<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># First we start with eye</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">eyeCluster</span> <span class="op">&lt;-</span> <span class="va">eyeCluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://satijalab.org/seurat/reference/SCTransform.html">SCTransform</a></span><span class="op">(</span>assay <span class="op">=</span> <span class="st">"Spatial"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html">FindNeighbors</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html">FindClusters</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span>


<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Embryonic eye markers</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">eyeMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindAllMarkers.html">FindAllMarkers</a></span><span class="op">(</span><span class="va">eyeCluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
                             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html">top_n</a></span><span class="op">(</span><span class="fl">15</span>,wt <span class="op">=</span> <span class="va">avg_logFC</span><span class="op">)</span>

<span class="va">eyeClusterMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extractClusterMarkers.html">extractClusterMarkers</a></span><span class="op">(</span><span class="va">eyeCluster</span>,<span class="va">embryoCounts</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seedTerritory</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html">top_n</a></span><span class="op">(</span><span class="fl">15</span>,wt <span class="op">=</span> <span class="va">logFC</span><span class="op">)</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Here we compare cluster between each other and more specifically clusters</span>
<span class="co"># associated with different cell type layers in the embryonic eye.</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">epiComp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindMarkers.html">FindMarkers</a></span><span class="op">(</span><span class="va">eyeCluster</span>,ident.1 <span class="op">=</span> <span class="fl">1</span>, ident.2 <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="va">lensComp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindMarkers.html">FindMarkers</a></span><span class="op">(</span><span class="va">eyeCluster</span>,ident.1 <span class="op">=</span><span class="fl">4</span>,ident.2<span class="op">=</span><span class="fl">6</span><span class="op">)</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Plotting and Assigning cell types</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">eye</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FetchData.html">FetchData</a></span><span class="op">(</span><span class="va">eyeCluster</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"UMAP_1"</span>,<span class="st">"UMAP_2"</span>,<span class="st">"seurat_clusters"</span><span class="op">)</span><span class="op">)</span>
<span class="va">eye_ISH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Primary Lens Fiber Cells"</span>,
             <span class="st">"Anterior Lens Epithelial Cells"</span>,
             <span class="st">"Preplacodal Lens Ectoderm Cells"</span>,
             <span class="st">"Periocular Mesenchyme"</span>,
             <span class="st">"Lens Vesicle Cells"</span>,
             <span class="st">"Anterior Lens Epithelial Cells - L2"</span>,
             <span class="st">"Lens Vesicle Cells - L2"</span>,
             <span class="st">"Primary Lens Fiber Cells"</span><span class="op">)</span>

<span class="va">coordeye</span> <span class="op">&lt;-</span> <span class="fu">Vesalius</span><span class="fu">:::</span><span class="fu">.getSeuratCoordinates</span><span class="op">(</span><span class="va">eyeCluster</span><span class="op">)</span>
<span class="va">eye</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">eye</span>,<span class="va">coordeye</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>xs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">UMAP_1</span><span class="op">)</span>,ys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">UMAP_2</span><span class="op">)</span><span class="op">)</span>

<span class="va">lvls</span> <span class="op">&lt;-</span> <span class="va">eye_ISH</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">eye</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>
<span class="va">eye</span><span class="op">$</span><span class="va">seurat_clusters</span> <span class="op">&lt;-</span> <span class="va">lvls</span>

<span class="va">eye_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">eye</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#F0E442"</span>,
          <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span><span class="op">)</span>

<span class="va">umap_eye</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">eye</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">UMAP_1</span>,<span class="va">UMAP_2</span>,col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.2</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span><span class="va">cols</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span>,
                  axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                  axis.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                  plot.caption <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span>,hjust <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,
                  plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,
                  plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.2</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>caption <span class="op">=</span> <span class="st">"Embryonic Eye (E12.5)"</span>,
                                              x <span class="op">=</span> <span class="st">"UMAP 1"</span>, y <span class="op">=</span> <span class="st">"UMAP 2"</span><span class="op">)</span>

<span class="va">coord_eye</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">eye</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1.4</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span>
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                   legend.position <span class="op">=</span><span class="st">"left"</span>,
                   plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                   plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">20</span><span class="op">)</span>,
                   plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">""</span>, title <span class="op">=</span> <span class="st">""</span>,
                                x <span class="op">=</span> <span class="st">"X coordinates"</span>, y <span class="op">=</span> <span class="st">"Y coordinates"</span><span class="op">)</span>


<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Finally we can build the isolated territory section of the figure</span>
<span class="co"># if you want everything in one plot</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co">#pdf("fig_3_template.pdf",height=10,width=24)</span>
<span class="va">umap_CA</span><span class="op">+</span><span class="va">umap_med</span> <span class="op">+</span><span class="va">umap_eye</span><span class="op">+</span> <span class="va">coord_CA</span><span class="op">+</span><span class="va">coord_med</span><span class="op">+</span><span class="va">coord_eye</span> <span class="op">+</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">3</span>,height<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1.2</span><span class="op">)</span><span class="op">)</span>
<span class="co">#dev.off()              </span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Indiv plots</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co">#pdf("CA_field.pdf",width = 10, height=12)</span>
<span class="va">coord_CA</span> <span class="op">+</span> <span class="va">umap_CA</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="co">#dev.off()</span>


<span class="co">#pdf("med.pdf", width = 10,height=12)</span>
<span class="va">umap_med</span> <span class="op">+</span> <span class="va">coord_med</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="co">#dev.off()</span>


<span class="co">#pdf("Eye.pdf", width =15, height = 6)</span>
<span class="va">umap_eye</span> <span class="op">+</span> <span class="va">coord_eye</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol <span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="co">#dev.off()</span></code></pre></div>
<p>We showed that we recovered the CA2 field in the CA field isolated territory This was due to the fact that we could recover subtle gene expression patterns that were otherwise lost or overshadowed by stronger patterns. In this section, we show how we can visualise these expression patterns</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#-------------------/CA2 field marker expression patterns/---------------------#</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># First we show the overall and isolated pattern for pcp4 (as in main figure 3)</span>
<span class="co">#------------------------------------------------------------------------------#</span>

<span class="va">pcp4All</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewGeneExpression.html">viewGeneExpression</a></span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainCounts</span>,
                              ter <span class="op">=</span> <span class="cn">NULL</span>, genes <span class="op">=</span> <span class="st">"Pcp4"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span>
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'bottom'</span>,
                 plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Only in CA field</span>
<span class="co">#pcp4 &lt;- viewGeneExpression(imageBrain,CACluster, genes = "Pcp4",cex=20)+</span>
<span class="co">#        theme_void()+</span>
<span class="co">#        theme(legend.position='bottom',</span>
<span class="co">#              plot.title = element_text(hjust=0.5))</span>
<span class="co">#pdf("pcp4.pdf",width=5,height=5)</span>
<span class="va">pcp4All</span>
<span class="co">#dev.off()</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Next we do the same thing but for supplementary figure 2</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">rgs14All</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewGeneExpression.html">viewGeneExpression</a></span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainCounts</span>,
                              ter <span class="op">=</span> <span class="cn">NULL</span>, genes <span class="op">=</span> <span class="st">"Rgs14"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'left'</span>,
            plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>
<span class="va">rgs14</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewGeneExpression.html">viewGeneExpression</a></span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">CACluster</span>,
                            genes <span class="op">=</span> <span class="st">"Rgs14"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span>
         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'left'</span>,
               plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>


<span class="va">necab2All</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewGeneExpression.html">viewGeneExpression</a></span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainCounts</span>,
                                ter <span class="op">=</span> <span class="cn">NULL</span>, genes <span class="op">=</span> <span class="st">"Necab2"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span>
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'right'</span>,
                   plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>
<span class="va">necab2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewGeneExpression.html">viewGeneExpression</a></span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">CACluster</span>,
                             genes <span class="op">=</span> <span class="st">"Necab2"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'right'</span>,
                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>



<span class="co">#pdf("CA2_inClust_overall.pdf",width = 10,height = 4)</span>
<span class="va">rgs14All</span> <span class="op">+</span> <span class="va">necab2All</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">2</span>,nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#dev.off()</span>

<span class="co">#pdf("CA2_markers_inCluster.pdf",width = 10,height = 4)</span>
<span class="va">rgs14</span> <span class="op">+</span> <span class="va">necab2</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">2</span>,nrow <span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="co">#dev.off()</span></code></pre></div>
<p>We can also visualise differentially expressed genes between layers in the eye.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Cryba4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewGeneExpression.html">viewGeneExpression</a></span><span class="op">(</span><span class="va">imageEmbryo</span>,<span class="va">eyeCluster</span>,
                             genes <span class="op">=</span> <span class="st">"Cryba4"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'none'</span>,
                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>



<span class="va">Ccnd2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewGeneExpression.html">viewGeneExpression</a></span><span class="op">(</span><span class="va">imageEmbryo</span>,<span class="va">eyeCluster</span>,
                             genes <span class="op">=</span> <span class="st">"Ccnd2"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'right'</span>,
                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>



<span class="va">Pmel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewGeneExpression.html">viewGeneExpression</a></span><span class="op">(</span><span class="va">imageEmbryo</span>,<span class="va">eyeCluster</span>,
                             genes <span class="op">=</span> <span class="st">"Pmel"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'none'</span>,
                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>


<span class="va">Aldh1a1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewGeneExpression.html">viewGeneExpression</a></span><span class="op">(</span><span class="va">imageEmbryo</span>,<span class="va">eyeCluster</span>,
                             genes <span class="op">=</span> <span class="st">"Aldh1a1"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">'right'</span>,
                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html">pdf</a></span><span class="op">(</span><span class="st">"epiEye.pdf"</span>, width <span class="op">=</span> <span class="fl">5</span>,height <span class="op">=</span><span class="fl">4</span><span class="op">)</span>

<span class="va">Cryba4</span><span class="op">+</span><span class="va">Ccnd2</span><span class="op">+</span><span class="va">Pmel</span> <span class="op">+</span><span class="va">Aldh1a1</span> <span class="op">+</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html">plot_layout</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html">dev.off</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="tissue-markers-and-tissue-border-expression" class="section level2">
<h2 class="hasAnchor">
<a href="#tissue-markers-and-tissue-border-expression" class="anchor"></a>Tissue markers and tissue border expression</h2>
<p>The final section of the paper showed how we could extract markers from anatomical territories and how we found tissue border expression patterns. We also showed an example of a layering effect in the corpus callosum.</p>
<p>First, we will show the code associated with the extraction of Dentate gyrus and the associated marker genes.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#----------/Dentate gyrus: novel markers and border expression/----------------#</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># First we extract makers from the territory</span>
<span class="co"># We do not apply any morphological operator in this case but we will pool</span>
<span class="co"># territories to remove anything that is non contiguous</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">imageDentate</span> <span class="op">&lt;-</span> <span class="va">imageBrain</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
                <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">territory</span> <span class="op">==</span><span class="fl">29</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
                <span class="fu"><a href="../../reference/isolateTerritories.array.html">isolateTerritories.array</a></span><span class="op">(</span>captureRadius<span class="op">=</span><span class="fl">0.025</span><span class="op">)</span>
<span class="va">DenMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extractMarkers.html">extractMarkers</a></span><span class="op">(</span><span class="va">imageDentate</span>,<span class="va">brainCounts</span>,<span class="fl">1</span>,morphologyFactorSeed <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Next we run a clustering analysis on the dentate gyrus</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">DenCluster</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extractTerritories.html">extractTerritories</a></span><span class="op">(</span><span class="va">imageDentate</span>, <span class="va">brainRaw</span>,
                                        seedID <span class="op">=</span> <span class="fl">1</span>,morphologyFactor <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>

<span class="va">DenCluster</span> <span class="op">&lt;-</span> <span class="va">DenCluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/SCTransform.html">SCTransform</a></span><span class="op">(</span>assay <span class="op">=</span> <span class="st">"Spatial"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://satijalab.org/seurat/reference/RunPCA.html">RunPCA</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span>dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
              <span class="fu"><a href="https://satijalab.org/seurat/reference/FindNeighbors.html">FindNeighbors</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">DenCluster</span> <span class="op">&lt;-</span> <span class="va">DenCluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindClusters.html">FindClusters</a></span><span class="op">(</span>resolution <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># We can extract marker gene from each cluster and compare each cluster</span>
<span class="co"># to all other territories</span>
<span class="co"># NOTE: for cell type annotation we used anatomical position as we just wanted</span>
<span class="co"># overall territory not specific cell types</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">denMarkersOuterSeu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FindAllMarkers.html">FindAllMarkers</a></span><span class="op">(</span><span class="va">DenCluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
                      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
                      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html">top_n</a></span><span class="op">(</span><span class="fl">25</span>,wt<span class="op">=</span><span class="va">avg_logFC</span><span class="op">)</span>

<span class="va">denClusterMarkers</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/extractClusterMarkers.html">extractClusterMarkers</a></span><span class="op">(</span><span class="va">DenCluster</span>,<span class="va">brainCounts</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
                     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seedTerritory</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html">top_n</a></span><span class="op">(</span><span class="fl">15</span>,wt <span class="op">=</span> <span class="va">logFC</span><span class="op">)</span>




<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># We now have all the data we need to do some plotting</span>
<span class="co"># We start off with the clustered dentate gyrus</span>
<span class="co"># We only show the coordinates</span>
<span class="co">#------------------------------------------------------------------------------#</span>

<span class="va">outer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.org/seurat/reference/FetchData.html">FetchData</a></span><span class="op">(</span><span class="va">DenCluster</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"UMAP_1"</span>,<span class="st">"UMAP_2"</span>,<span class="st">"seurat_clusters"</span><span class="op">)</span><span class="op">)</span>

<span class="va">coordouter</span> <span class="op">&lt;-</span> <span class="fu">Vesalius</span><span class="fu">:::</span><span class="fu">getSeuratCoordinates</span><span class="op">(</span><span class="va">DenCluster</span><span class="op">)</span>
<span class="va">outer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">outer</span>,<span class="va">coordouter</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>,<span class="st">"y"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>
               <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>xs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">UMAP_1</span><span class="op">)</span>,ys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">UMAP_2</span><span class="op">)</span><span class="op">)</span>

<span class="va">outer_ISH</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"DG - Granule Cell Layer"</span>,
               <span class="st">"DG - Granule Cell Layer"</span>,
               <span class="st">"DG - Sub-Granular Zone"</span><span class="op">)</span>

<span class="va">lvls</span> <span class="op">&lt;-</span> <span class="va">outer_ISH</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">outer</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>
<span class="va">outer</span><span class="op">$</span><span class="va">seurat_clusters</span> <span class="op">&lt;-</span> <span class="va">lvls</span>
<span class="va">outer_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">outer</span><span class="op">$</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span>

<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>,
          <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span>

<span class="va">coord_outer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">outer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">y</span>,col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">seurat_clusters</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="va">cols</span><span class="op">)</span> <span class="op">+</span>
               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">16</span><span class="op">)</span>,
                     legend.position <span class="op">=</span> <span class="st">"top"</span>,
                     legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,
                     plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">15</span>,hjust <span class="op">=</span><span class="fl">0</span><span class="op">)</span>,
                     plot.tag <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="st">" "</span>, title <span class="op">=</span> <span class="st">" "</span>,
                           x <span class="op">=</span> <span class="st">" "</span>, y <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>

<span class="co">#pdf("DenMaps_umap.pdf", width =9, height=9)</span>
<span class="va">coord_outer</span>
<span class="co">#dev.off()</span>

<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># We plot the expression of the territory markers</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">cAll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewGeneExpression.html">viewGeneExpression</a></span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainCounts</span>,ter <span class="op">=</span> <span class="cn">NULL</span>,
                           genes <span class="op">=</span> <span class="st">"C1ql2"</span>,cex<span class="op">=</span><span class="fl">25</span><span class="op">)</span> <span class="op">+</span>
        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"left"</span>,
              plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="st">"cm"</span><span class="op">)</span>,
              plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">1</span>,size <span class="op">=</span><span class="fl">25</span><span class="op">)</span>,
              legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
              legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span>

<span class="va">lAll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewGeneExpression.html">viewGeneExpression</a></span><span class="op">(</span><span class="va">imageBrain</span>,<span class="va">brainCounts</span>,ter <span class="op">=</span> <span class="cn">NULL</span>,
                           genes <span class="op">=</span> <span class="st">"Stxbp6"</span>,cex<span class="op">=</span><span class="fl">25</span><span class="op">)</span> <span class="op">+</span>
        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="st">"cm"</span><span class="op">)</span>,
              plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0</span>,size <span class="op">=</span><span class="fl">25</span><span class="op">)</span>,
              legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
              legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span><span class="op">)</span>



<span class="co">#pdf("denMarkersC1.pdf",width = 7.5,height = 6)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">cAll</span><span class="op">)</span>
<span class="co">#dev.off()</span>
<span class="co">#pdf("denMarkersStxbp6.pdf",width = 7.5,height = 6)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">lAll</span><span class="op">)</span>
<span class="co">#dev.off()</span></code></pre></div>
<p>The final part of our analysis concerned itself with the Corpus Callosum. We isolated the Corpus Callosum and applied morphological operators to fill in the holes and gaps. Then, we layered this isolated territory and after extracting layer specific genes, we found the Kif5a and Stmn4 genes that were highly expressed in the inner layers of the Corpus Callosum.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#-----------------/Corpus Callosum : internal expression /---------------------#</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># First step is to dilate the territory to fill in gaps and consider</span>
<span class="co"># neighbouring territories</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/layerTerritory.edge.html">layerTerritory.edge</a></span><span class="op">(</span><span class="va">imageBrain</span>,<span class="fl">11</span>,morphologyFactor<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">35</span><span class="op">)</span>,layerDepth <span class="op">=</span><span class="fl">10</span><span class="op">)</span>


<span class="co">#------------------------------------------------------------------------------#</span>
<span class="co"># Now we can find layer specific gene expresison</span>
<span class="co">#------------------------------------------------------------------------------#</span>
<span class="va">totalLayerssc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">sc</span><span class="op">$</span><span class="va">layer</span><span class="op">)</span>

<span class="va">Layeredsc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">totalLayerssc</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">idx</span>,<span class="va">layers</span>,<span class="va">ter</span>,<span class="va">counts</span><span class="op">)</span><span class="op">{</span>
                    <span class="va">query</span> <span class="op">&lt;-</span> <span class="va">layers</span><span class="op">[</span><span class="op">!</span><span class="va">layers</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">idx</span><span class="op">]</span>
                    <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/compareLayers.html">compareLayers</a></span><span class="op">(</span><span class="va">ter</span>,<span class="va">counts</span>,<span class="va">idx</span>,<span class="va">query</span>,logFC <span class="op">=</span><span class="fl">0.2</span><span class="op">)</span>
                    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">==</span><span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span>
                    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span>
<span class="op">}</span>,<span class="va">totalLayerssc</span>,<span class="va">sc</span>,<span class="va">brainCounts</span><span class="op">)</span>
<span class="va">Layeredsc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>,<span class="va">Layeredsc</span><span class="op">)</span>
<span class="va">Layeredsc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">Layeredsc</span> ,<span class="va">logFC</span> <span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span>

<span class="co">#pdf("sc_layer_genes.pdf",width=9,height=7)</span>
<span class="va">scPlot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewLayerExpression.html">viewLayerExpression</a></span><span class="op">(</span><span class="va">sc</span>,<span class="va">brainCounts</span>,genes <span class="op">=</span> <span class="st">"Kif5a"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="st">"cm"</span><span class="op">)</span>,
                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">25</span><span class="op">)</span>,
                legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
                legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span><span class="st">"Kif5a"</span><span class="op">)</span>
<span class="va">scPlot</span>
<span class="co">#dev.off()</span>
<span class="co">#pdf("sc_layer_genes2.pdf",width=9,height=7)</span>
<span class="va">scPlot2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/viewLayerExpression.html">viewLayerExpression</a></span><span class="op">(</span><span class="va">sc</span>,<span class="va">brainCounts</span>,genes <span class="op">=</span> <span class="st">"Stmn4"</span>,cex<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">margin</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="st">"cm"</span><span class="op">)</span>,
                plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">25</span><span class="op">)</span>,
                legend.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
                legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>,
                legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span>
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span><span class="st">"Stmn4"</span><span class="op">)</span>
<span class="va">scPlot2</span>
<span class="co">#dev.off()</span></code></pre></div>
</div>
</div>
<div id="conclusion" class="section level1">
<h1 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h1>
<p>This concludes the analysis related to the Vesalius paper. All figures and table are produced using the analysis and plots produced here.</p>
<p>All ISH images are taken from the Allen Brain Atlas and thus are not part of this pipeline.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Patrick C.N. Martin.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
